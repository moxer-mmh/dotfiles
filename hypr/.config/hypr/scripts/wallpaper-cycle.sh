#!/bin/bash
# =============================================================================
# üöÄ SPACE STATION WALLPAPER CYCLING SCRIPT üöÄ
# Automated cosmic wallpaper rotation with seamless transitions
# =============================================================================
# 
# This script provides automated wallpaper cycling with:
# - Random wallpaper selection from configured directory
# - Smooth fade transitions using SWWW (Wayland wallpaper daemon)
# - Dynamic symlink updates for Hyprlock integration
# - Configurable cycling intervals and image formats
# - Automatic reshuffling to prevent repetitive patterns
# - Real-time Hyprlock wallpaper reload support
#
# Dependencies:
#   - swww (Wayland wallpaper daemon)
#   - find (file discovery)
#   - ln (symlink creation)
#   - pkill (process signaling)
#
# Author: moxer_mmh
# Last Updated: June 2025
# Compatible with: SWWW 0.8+, Hyprland/Wayland
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# Customize these paths and settings for your environment
# -----------------------------------------------------------------------------
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"    # Source directory for wallpaper images
CURRENT_WALLPAPER="$HOME/.config/hypr/current_wallpaper"  # Symlink for active wallpaper
INTERVAL=30  # Cycling interval in seconds (30s = smooth rotation without distraction)

# -----------------------------------------------------------------------------
# WALLPAPER APPLICATION FUNCTION
# Handles the complete wallpaper switching process
# -----------------------------------------------------------------------------
set_wallpaper() {
    local wallpaper="$1"  # Input: Full path to wallpaper image file

    # Step 1: Update symlink for Hyprlock integration
    # This allows Hyprlock to automatically use the current wallpaper
    ln -sf "$wallpaper" "$CURRENT_WALLPAPER"

    # Step 2: Apply wallpaper using SWWW with smooth transition
    # --transition-type fade: Smooth fade between wallpapers (cosmic effect)
    # --transition-duration 2: 2-second transition for seamless experience
    swww img "$wallpaper" --transition-type fade --transition-duration 2

    # Step 3: Signal Hyprlock to reload wallpaper (if currently running)
    # USR2 signal triggers wallpaper reload without disrupting lock screen
    # 2>/dev/null suppresses error if hyprlock is not running
    pkill -USR2 hyprlock 2>/dev/null
}

# -----------------------------------------------------------------------------
# MAIN WALLPAPER CYCLING FUNCTION
# Discovers, randomizes, and cycles through wallpaper collection
# -----------------------------------------------------------------------------
cycle_wallpapers() {
    # Step 1: Discover all supported image files and randomize order
    # Supported formats: JPEG (.jpg, .jpeg) and PNG (.png)
    # | shuf: Randomizes the order to prevent predictable patterns
    mapfile -t wallpapers < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | shuf)

    # Step 2: Validate wallpaper collection
    if [ ${#wallpapers[@]} -eq 0 ]; then
        echo "‚ùå No wallpapers found in $WALLPAPER_DIR"
        echo "üìÅ Please add .jpg, .jpeg, or .png files to the wallpaper directory"
        return 1
    fi

    # Step 3: Initialize cosmic cycling process
    echo "üåå Starting cosmic wallpaper cycle with ${#wallpapers[@]} wallpapers"
    echo "‚è±Ô∏è  Interval: ${INTERVAL} seconds per wallpaper"
    echo "üìÇ Source: $WALLPAPER_DIR"

    # Step 4: Infinite cycling loop with reshuffling
    while true; do
        # Cycle through current wallpaper array
        for wallpaper in "${wallpapers[@]}"; do
            echo "üñºÔ∏è  Setting wallpaper: $(basename "$wallpaper")"
            set_wallpaper "$wallpaper"
            
            # Wait for configured interval before next wallpaper
            sleep "$INTERVAL"
        done
        
        # Step 5: Reshuffle wallpapers after each complete cycle
        # This prevents the same sequence from repeating and keeps it interesting
        echo "üîÑ Reshuffling wallpaper order for next cycle..."
        mapfile -t wallpapers < <(printf '%s\n' "${wallpapers[@]}" | shuf)
    done
}

# -----------------------------------------------------------------------------
# SCRIPT EXECUTION
# Initialize the cosmic wallpaper cycling process
# -----------------------------------------------------------------------------
echo "üöÄ Initializing Space Station Wallpaper System..."
echo "üì° Checking dependencies and configuration..."

# Validate wallpaper directory exists
if [ ! -d "$WALLPAPER_DIR" ]; then
    echo "‚ùå Error: Wallpaper directory does not exist: $WALLPAPER_DIR"
    echo "üìÅ Please create the directory and add wallpaper images"
    exit 1
fi

# Validate SWWW daemon is available
if ! command -v swww >/dev/null 2>&1; then
    echo "‚ùå Error: SWWW wallpaper daemon not found"
    echo "üì¶ Please install SWWW: sudo pacman -S swww"
    exit 1
fi

# Start the cosmic wallpaper cycling
cycle_wallpapers

# =============================================================================
# üìã WALLPAPER CYCLING SYSTEM SUMMARY
# =============================================================================
#
# CYCLING PROCESS FLOW:
#
# 1. üîç DISCOVERY PHASE:
#    ‚îî‚îÄ‚îÄ Scan ~/Pictures/Wallpapers/ for image files
#    ‚îî‚îÄ‚îÄ Filter: .jpg, .jpeg, .png formats
#    ‚îî‚îÄ‚îÄ Randomize order with shuf command
#    ‚îî‚îÄ‚îÄ Validate collection (exit if empty)
#
# 2. üîÑ CYCLING PHASE:
#    ‚îî‚îÄ‚îÄ Apply wallpaper with SWWW fade transition
#    ‚îî‚îÄ‚îÄ Update symlink for Hyprlock integration
#    ‚îî‚îÄ‚îÄ Signal Hyprlock to reload (if running)
#    ‚îî‚îÄ‚îÄ Wait 30 seconds before next wallpaper
#
# 3. üîÄ RESHUFFLE PHASE:
#    ‚îî‚îÄ‚îÄ After each complete cycle through all wallpapers
#    ‚îî‚îÄ‚îÄ Randomize order again to prevent repetition
#    ‚îî‚îÄ‚îÄ Continue infinite cycling loop
#
# =============================================================================
# üé® INTEGRATION WITH COSMIC ECOSYSTEM
# =============================================================================
#
# üñºÔ∏è HYPRLAND INTEGRATION:
#   ‚Ä¢ Uses SWWW daemon for Wayland wallpaper management
#   ‚Ä¢ Smooth fade transitions (2-second duration)
#   ‚Ä¢ Real-time wallpaper updates across all monitors
#
# üîí HYPRLOCK INTEGRATION:
#   ‚Ä¢ Creates symlink at ~/.config/hypr/current_wallpaper
#   ‚Ä¢ Hyprlock automatically uses current wallpaper as background
#   ‚Ä¢ USR2 signal triggers immediate reload during lock screen
#
# üåå COSMIC AESTHETIC:
#   ‚Ä¢ Space-themed output messages and emojis
#   ‚Ä¢ Seamless transitions maintain cosmic atmosphere
#   ‚Ä¢ Non-disruptive timing (30-second intervals)
#
# =============================================================================
# ‚öôÔ∏è CONFIGURATION OPTIONS
# =============================================================================
#
# üìÅ WALLPAPER DIRECTORY:
#   Default: ~/Pictures/Wallpapers/
#   Modify: Change WALLPAPER_DIR variable
#   
# ‚è±Ô∏è CYCLING INTERVAL:
#   Default: 30 seconds
#   Modify: Change INTERVAL variable
#   Recommendations:
#     ‚Ä¢ 15s: Fast cycling (demo/testing)
#     ‚Ä¢ 30s: Balanced (default)
#     ‚Ä¢ 60s: Slow cycling (focus-friendly)
#     ‚Ä¢ 300s: Very slow (5 minutes)
#
# üé≠ TRANSITION EFFECTS:
#   Current: fade (2-second duration)
#   Alternatives: wipe, left, right, top, bottom, center
#   Modify: Change --transition-type in set_wallpaper()
#
# üñºÔ∏è SUPPORTED FORMATS:
#   Current: .jpg, .jpeg, .png
#   Add formats: Modify find command pattern
#   Example: Add .webp: -o -iname "*.webp"
#
# =============================================================================
# üöÄ USAGE AND DEPLOYMENT
# =============================================================================
#
# üìã MANUAL EXECUTION:
#   chmod +x ~/.config/hypr/scripts/wallpaper-cycle.sh
#   ~/.config/hypr/scripts/wallpaper-cycle.sh
#
# üîÑ AUTOMATIC STARTUP:
#   Add to hyprland.conf:
#   exec-once = ~/.config/hypr/scripts/wallpaper-cycle.sh &
#
# üõë STOP CYCLING:
#   pkill -f wallpaper-cycle.sh
#
# üìä MONITOR STATUS:
#   ps aux | grep wallpaper-cycle
#   tail -f /tmp/wallpaper-cycle.log  # if logging added
#
# =============================================================================
# üõ†Ô∏è TROUBLESHOOTING GUIDE
# =============================================================================
#
# ‚ùå COMMON ISSUES:
#
# 1. "No wallpapers found":
#    ‚Ä¢ Check if ~/Pictures/Wallpapers/ exists
#    ‚Ä¢ Verify images are .jpg, .jpeg, or .png format
#    ‚Ä¢ Check file permissions (readable)
#
# 2. "SWWW daemon not found":
#    ‚Ä¢ Install SWWW: sudo pacman -S swww
#    ‚Ä¢ Start SWWW daemon: swww init
#    ‚Ä¢ Verify: swww query
#
# 3. "Wallpaper not changing":
#    ‚Ä¢ Check if SWWW daemon is running: swww query
#    ‚Ä¢ Verify script has execute permissions
#    ‚Ä¢ Check for error messages in terminal output
#
# 4. "Hyprlock not updating":
#    ‚Ä¢ Verify symlink exists: ls -la ~/.config/hypr/current_wallpaper
#    ‚Ä¢ Check Hyprlock reload_time setting (should be > 0)
#    ‚Ä¢ Ensure Hyprlock is running: pidof hyprlock
#
# =============================================================================
# üéØ PERFORMANCE CONSIDERATIONS
# =============================================================================
#
# üíæ MEMORY USAGE:
#   ‚Ä¢ Minimal: Script uses ~1-2MB RAM
#   ‚Ä¢ SWWW daemon: ~10-20MB RAM (normal)
#   ‚Ä¢ Image cache: Managed by SWWW automatically
#
# üñ•Ô∏è CPU IMPACT:
#   ‚Ä¢ Negligible during steady state
#   ‚Ä¢ Brief spike during transition (2 seconds)
#   ‚Ä¢ No impact on system performance
#
# üìä STORAGE CONSIDERATIONS:
#   ‚Ä¢ Wallpaper directory size affects startup time
#   ‚Ä¢ Recommended: 50-200 wallpapers for good variety
#   ‚Ä¢ Large images (>4K) may slow transitions slightly
#
# =============================================================================
# üîÆ FUTURE ENHANCEMENT IDEAS
# =============================================================================
#
# üåÖ TIME-BASED CYCLING:
#   ‚Ä¢ Morning: Bright, energetic wallpapers
#   ‚Ä¢ Evening: Dark, cosmic wallpapers
#   ‚Ä¢ Night: Minimal, dark wallpapers
#
# üé® THEME INTEGRATION:
#   ‚Ä¢ Match wallpapers to current color scheme
#   ‚Ä¢ Seasonal wallpaper collections
#   ‚Ä¢ Mood-based selections
#
# üì± REMOTE CONTROL:
#   ‚Ä¢ Skip to next wallpaper via keybinding
#   ‚Ä¢ Favorite/blacklist wallpapers
#   ‚Ä¢ Web interface for management
#
# ü§ñ INTELLIGENT SELECTION:
#   ‚Ä¢ Learn from user preferences
#   ‚Ä¢ Avoid recently used wallpapers
#   ‚Ä¢ Smart shuffling algorithms
#
# =============================================================================

